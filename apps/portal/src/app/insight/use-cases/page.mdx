import { createMetadata } from "@doc";

export const metadata = createMetadata({
	title: "Insight Use Cases | thirdweb Infrastructure",
	description: "Example use cases for thirdweb Insight",
  image: {
    title: "Insight",
    icon: "insight",
  },
});

# Use Cases

## Gaming

### Show assets owned by players
In blockchain games, players often own digital assets such as in-game items or tokens. To display these assets, the events blueprint can track Transfer events of ERC-721 (NFT) or ERC-1155 tokens, allowing you to determine which assets belong to each player's wallet.
- The Events blueprint can be used to fetch Transfer events where the player's wallet is the recipient, showing all NFTs or in-game items acquired by the player.

```typescript
const getPlayerAssets = async (playerAddress, gameContractAddress) => {
  try {
    // Use the events blueprint to get all Transfer events where the player is the recipient
    const response = await fetch(
      `https://1.insight.thirdweb.com/v1/events/${gameContractAddress}/Transfer(address,address,uint256)?to=${playerAddress}&limit=100`,
      {
        headers: {
          'x-client-id': '<YOUR_THIRDWEB_CLIENT_ID>'
        }
      }
    );
    
    const assets = await response.json();
    return assets;
  } catch (error) {
    console.error('Error fetching player assets:', error);
  }
};
```

### Show users the tokens they earned
Some games reward players with tokens based on achievements or progress. Using the transactions blueprint, you can display these earned tokens by tracking transactions where the game's smart contract sends tokens to the player's wallet.
- Transactions Blueprint: Shows all transactions where the game contract transfers tokens to players.
- Events Blueprint: Filters Transfer events from the game's contract to list all tokens awarded to players.

```typescript
const getPlayerTokenRewards = async (playerAddress, gameContractAddress) => {
  try {
    // Using transactions blueprint to see all token transfers from game contract to player
    const txResponse = await fetch(
      `https://1.insight.thirdweb.com/v1/transactions?from=${gameContractAddress}&to=${playerAddress}&limit=50`,
      {
        headers: {
          'x-client-id': '<YOUR_THIRDWEB_CLIENT_ID>'
        }
      }
    );
    
    // Using events blueprint to get Transfer events specifically
    const eventsResponse = await fetch(
      `https://1.insight.thirdweb.com/v1/events/${gameContractAddress}/Transfer(address,address,uint256)?from=${gameContractAddress}&to=${playerAddress}&limit=50`,
      {
        headers: {
          'x-client-id': '<YOUR_THIRDWEB_CLIENT_ID>'
        }
      }
    );
    
    const transactions = await txResponse.json();
    const events = await eventsResponse.json();
    
    return {
      transactions: transactions.data,
      events: events.data
    };
  } catch (error) {
    console.error('Error fetching player rewards:', error);
  }
};
```

## DeFi

### Analyse Token Economics e.g. USDC 24h volume
Token economics, like daily trading volume, helps in understanding a token's liquidity and market activity. By using the transactions blueprint users can get transactions involving USDC and then aggregating data based on timestamps, you can calculate 24-hour transaction volume.
- Transactions Blueprint: Retrieves all USDC transactions in the past 24 hours, enabling calculation of volume and other economic indicators.

```typescript
const getUSDC24hVolume = async () => {
  try {
    const usdcAddress = '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48'; // USDC on Ethereum
    const now = Math.floor(Date.now() / 1000);
    const oneDayAgo = now - 86400; // 24 hours in seconds
    
    // Get all transactions involving USDC in the last 24 hours
    const response = await fetch(
      `https://1.insight.thirdweb.com/v1/transactions?to=${usdcAddress}&from_timestamp=${oneDayAgo}&to_timestamp=${now}&limit=1000`,
      {
        headers: {
          'x-client-id': '<YOUR_THIRDWEB_CLIENT_ID>'
        }
      }
    );
    
    const txData = await response.json();
    
    // Calculate total volume by summing the value of all transactions
    const totalVolume = txData.data.reduce((sum, tx) => sum + BigInt(tx.value), BigInt(0));
    
    return {
      volume: totalVolume.toString(),
      transactionCount: txData.data.length,
      startTime: oneDayAgo,
      endTime: now
    };
  } catch (error) {
    console.error('Error calculating USDC volume:', error);
  }
};
```

### Optimize protocol gas efficiency
DeFi protocols aim to minimize gas fees for users. Using the transactions blueprint allow users to analyze the gas consumption of different transactions, you can identify areas where gas optimization is possible by evaluating high-gas transactions or commonly used functions.
- Transactions Blueprint: Summarizes gas usage across transactions for specific functions, helping to analyze and optimize protocol functions for efficiency.

```typescript
const analyzeProtocolGasUsage = async (protocolAddress, days = 7) => {
  try {
    const now = Math.floor(Date.now() / 1000);
    const startTime = now - (days * 86400); // Convert days to seconds
    
    // Get all transactions for the protocol in the specified period
    const response = await fetch(
      `https://1.insight.thirdweb.com/v1/transactions?to=${protocolAddress}&from_timestamp=${startTime}&to_timestamp=${now}&limit=500`,
      {
        headers: {
          'x-client-id': '<YOUR_THIRDWEB_CLIENT_ID>'
        }
      }
    );
    
    const txData = await response.json();
    
    // Group transactions by function signature (first 10 bytes of data)
    const functionGasUsage = {};
    
    txData.data.forEach(tx => {
      const functionSignature = tx.data.slice(0, 10); // Get first 10 bytes
      if (!functionGasUsage[functionSignature]) {
        functionGasUsage[functionSignature] = {
          count: 0,
          totalGas: BigInt(0),
          avgGas: 0,
          maxGas: BigInt(0)
        };
      }
      
      const gas = BigInt(tx.gas);
      functionGasUsage[functionSignature].count += 1;
      functionGasUsage[functionSignature].totalGas += gas;
      functionGasUsage[functionSignature].avgGas = Number(functionGasUsage[functionSignature].totalGas) / functionGasUsage[functionSignature].count;
      
      if (gas > functionGasUsage[functionSignature].maxGas) {
        functionGasUsage[functionSignature].maxGas = gas;
      }
    });
    
    return {
      totalTransactions: txData.data.length,
      period: `${days} days`,
      functionGasUsage
    };
  } catch (error) {
    console.error('Error analyzing gas usage:', error);
  }
};
```

### Analyse Token ownership
Understanding who holds a token (e.g., whales, retail investors) is crucial in DeFi to gauge community health and investment risk. The events blueprint helps track token transfer events, where users can analyze the distribution and concentration of token holders.
- Events Blueprint: Retrieves Transfer events to build a map of current token holders, showing distributions among wallets.

```typescript
const analyzeTokenOwnership = async (tokenAddress, limit = 1000) => {
  try {
    // Get Transfer events for the token
    const response = await fetch(
      `https://1.insight.thirdweb.com/v1/events/${tokenAddress}/Transfer(address,address,uint256)?limit=${limit}`,
      {
        headers: {
          'x-client-id': '<YOUR_THIRDWEB_CLIENT_ID>'
        }
      }
    );
    
    const events = await response.json();
    
    // Build a map of token holders and their balances
    const holders = {};
    
    events.data.forEach(event => {
      // Extract from and to addresses from topics
      const fromAddress = '0x' + event.topics[1].slice(26);
      const toAddress = '0x' + event.topics[2].slice(26);
      const amount = BigInt(event.data);
      
      // Subtract from sender
      if (holders[fromAddress]) {
        holders[fromAddress] = holders[fromAddress] - amount;
      } else {
        holders[fromAddress] = BigInt(0) - amount;
      }
      
      // Add to recipient
      if (holders[toAddress]) {
        holders[toAddress] = holders[toAddress] + amount;
      } else {
        holders[toAddress] = amount;
      }
    });
    
    // Filter out zero balances and sort by amount
    const sortedHolders = Object.entries(holders)
      .filter(([_, balance]) => balance > 0)
      .sort((a, b) => (b[1] > a[1] ? 1 : -1));
    
    return {
      totalHolders: sortedHolders.length,
      topHolders: sortedHolders.slice(0, 10) // Top 10 holders
    };
  } catch (error) {
    console.error('Error analyzing token ownership:', error);
  }
};
```

## NFTs

### Get all transfers of an NFT collection
To track the movement of an entire NFT collection, users can use the events blueprint to capture all Transfer events for that collection. This helps show ownership history or current trading volume for the collection.
- Events Blueprint: Queries Transfer events by contract address, returning each transfer for the NFT collection.

```typescript
const getNFTCollectionTransfers = async (collectionAddress, limit = 100) => {
  try {
    // Get all Transfer events for the NFT collection
    const response = await fetch(
      `https://1.insight.thirdweb.com/v1/events/${collectionAddress}/Transfer(address,address,uint256)?limit=${limit}`,
      {
        headers: {
          'x-client-id': '<YOUR_THIRDWEB_CLIENT_ID>'
        }
      }
    );
    
    const transfers = await response.json();
    
    // Process the transfers to extract relevant information
    const processedTransfers = transfers.data.map(event => {
      return {
        tokenId: BigInt(event.data).toString(),
        from: '0x' + event.topics[1].slice(26),
        to: '0x' + event.topics[2].slice(26),
        blockNumber: event.block_number,
        timestamp: event.block_timestamp,
        transactionHash: event.transaction_hash
      };
    });
    
    return {
      collection: collectionAddress,
      transfers: processedTransfers
    };
  } catch (error) {
    console.error('Error fetching NFT transfers:', error);
  }
};
```

### Get All NFTs owned by address
To show all NFTs owned by a user, users can use the events blueprint to fetch Transfer events where the specified address is the recipient. This shows a complete list of NFTs in their wallet.
- Events Blueprint: Retrieves Transfer events for each NFT contract where the wallet address is the recipient.

```typescript
const getNFTsOwnedByAddress = async (ownerAddress) => {
  try {
    // Use the tokens blueprint to get all ERC-721 tokens owned by the address
    const response = await fetch(
      `https://1.insight.thirdweb.com/v1/tokens/erc721/${ownerAddress}`,
      {
        headers: {
          'x-client-id': '<YOUR_THIRDWEB_CLIENT_ID>'
        }
      }
    );
    
    const nfts = await response.json();
    
    // Process the results to make them more readable
    const processedNFTs = nfts.map(nft => {
      return {
        collectionAddress: nft.collectionAddress,
        tokenId: nft.tokenId,
        balance: nft.balance
      };
    });
    
    return {
      owner: ownerAddress,
      nftCount: processedNFTs.length,
      nfts: processedNFTs
    };
  } catch (error) {
    console.error('Error fetching owned NFTs:', error);
  }
};
```

## Wallets

### Get all transactions performed by a wallet cross chain
Wallet activity often spans multiple chains. By using the transactions blueprint with the wallet address across different chain_ids, users can retrieve a cross-chain view of all transactions for that wallet.
- Transactions Blueprint: Filters transactions by wallet address and chain ID, providing a history of cross-chain transactions.

```typescript
const getWalletCrossChainTransactions = async (walletAddress, limit = 100) => {
  try {
    // Query transactions across Ethereum, Polygon, and Arbitrum
    const chainIds = [1, 137, 42161]; // Ethereum, Polygon, Arbitrum
    
    // Use multichain query format
    const queryParams = chainIds.map(chain => `chain=${chain}`).join('&');
    
    const response = await fetch(
      `https://insight.thirdweb.com/v1/transactions?${queryParams}&from=${walletAddress}&limit=${limit}`,
      {
        headers: {
          'x-client-id': '<YOUR_THIRDWEB_CLIENT_ID>'
        }
      }
    );
    
    const transactions = await response.json();
    
    // Group transactions by chain
    const transactionsByChain = {};
    
    chainIds.forEach(chainId => {
      transactionsByChain[chainId] = transactions.data.filter(tx => tx.chain_id === chainId);
    });
    
    return {
      wallet: walletAddress,
      totalTransactions: transactions.data.length,
      transactionsByChain
    };
  } catch (error) {
    console.error('Error fetching cross-chain transactions:', error);
  }
};
```

### Get all ERC-20 tokens owned by a wallet
This allows users to see all ERC-20 tokens they own. By using the events blueprint to find Transfer events where the wallet address is the recipient, you can list each ERC-20 token held by that wallet.
- Events Blueprint: Tracks Transfer events of ERC-20 tokens to the wallet address, providing a list of token balances.

```typescript
const getERC20TokensOwnedByWallet = async (walletAddress) => {
  try {
    // Use the tokens blueprint to get all ERC-20 tokens owned by the address
    const response = await fetch(
      `https://1.insight.thirdweb.com/v1/tokens/erc20/${walletAddress}`,
      {
        headers: {
          'x-client-id': '<YOUR_THIRDWEB_CLIENT_ID>'
        }
      }
    );
    
    const tokens = await response.json();
    
    // Process the results to make them more readable
    const processedTokens = tokens.map(token => {
      return {
        tokenAddress: token.tokenAddress,
        balance: token.balance
      };
    });
    
    return {
      wallet: walletAddress,
      tokenCount: processedTokens.length,
      tokens: processedTokens
    };
  } catch (error) {
    console.error('Error fetching owned ERC-20 tokens:', error);
  }
};
```

### Detect wallet staking activity (e.g. AAVE)
To identify staking activity in AAVE or any DeFi protocol, users can use the events blueprint to watch for staking-related events, such as Deposit or Stake events on any protocol e.g. AAVE's smart contracts. This helps monitor which wallets are actively staking assets.
- Events Blueprint: Filters by staking events on AAVE's staking contracts for the wallet address, providing insights into wallet staking activity.

```typescript
const detectAAVEStakingActivity = async (walletAddress) => {
  try {
    // AAVE staking contract address (for example purposes)
    const aaveStakingAddress = '0x4da27a545c0c5B758a6BA100e3a049001de870f5';
    
    // Get Stake events where the wallet is involved
    const stakeResponse = await fetch(
      `https://1.insight.thirdweb.com/v1/events/${aaveStakingAddress}/Stake(address,address,uint256,uint256)?user=${walletAddress}&limit=50`,
      {
        headers: {
          'x-client-id': '<YOUR_THIRDWEB_CLIENT_ID>'
        }
      }
    );
    
    // Get Redeem events where the wallet is involved
    const redeemResponse = await fetch(
      `https://1.insight.thirdweb.com/v1/events/${aaveStakingAddress}/Redeem(address,address,uint256)?user=${walletAddress}&limit=50`,
      {
        headers: {
          'x-client-id': '<YOUR_THIRDWEB_CLIENT_ID>'
        }
      }
    );
    
    const stakeEvents = await stakeResponse.json();
    const redeemEvents = await redeemResponse.json();
    
    // Process stake events
    const stakes = stakeEvents.data.map(event => {
      // Parse event data based on AAVE staking event structure
      return {
        type: 'stake',
        amount: BigInt(event.data).toString(),
        blockNumber: event.block_number,
        timestamp: event.block_timestamp,
        transactionHash: event.transaction_hash
      };
    });
    
    // Process redeem events
    const redeems = redeemEvents.data.map(event => {
      // Parse event data based on AAVE staking event structure
      return {
        type: 'redeem',
        amount: BigInt(event.data).toString(),
        blockNumber: event.block_number,
        timestamp: event.block_timestamp,
        transactionHash: event.transaction_hash
      };
    });
    
    // Combine and sort all events by timestamp
    const allEvents = [...stakes, ...redeems].sort((a, b) => a.timestamp - b.timestamp);
    
    return {
      wallet: walletAddress,
      stakingActivity: allEvents,
      totalStakeEvents: stakes.length,
      totalRedeemEvents: redeems.length
    };
  } catch (error) {
    console.error('Error detecting AAVE staking activity:', error);
  }
};
```

