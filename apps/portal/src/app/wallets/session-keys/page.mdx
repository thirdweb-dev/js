import { Tabs, TabsList, TabsTrigger, TabsContent } from "@doc";

# Session Keys Guide

Session keys enable secure transaction execution on behalf of accounts without requiring direct access to the main account's private key. This guide covers session keys for both ERC-4337 smart accounts and ERC-7702 smart EOAs (Externally Owned Accounts).

<Tabs defaultValue="erc7702">
<TabsList>
<TabsTrigger value="erc7702">EIP-7702 Upgraded EOAs</TabsTrigger>
<TabsTrigger value="erc4337">ERC-4337 Smart Accounts</TabsTrigger>
</TabsList>

<TabsContent value="erc4337">

## Prerequisites

Before you begin, ensure you have:
- A thirdweb client configured
- Access to a session key account address

## Setup

First, let's set up the necessary imports and configuration:

```typescript
import { 
  generateAccount, 
  smartWallet, 
  sendTransaction, 
  getContract,
  createThirdwebClient
} from "thirdweb";
import { sepolia } from "thirdweb/chains";
import { getAllActiveSigners } from "thirdweb/extensions/erc4337";
import { Engine } from "thirdweb/engine";

// Configure your client
const client = createThirdwebClient({
  clientId: "your-client-id",
  secretKey: "your-secret-key" // Only use in server environments
});

// Your session key account address
const sessionKeyAccountAddress = "0x..."; // Replace with your session key address (server wallet)

// Target address for transactions
const targetAddress = "0x..."; // Replace with your target address
```

## Step 1: Configure User Smart Wallet with Session Key

The first step is to add our session key address as a signer to the user's smart account. This is typically done on the client side since it needs explicit user approval. This can be done by configuring the smart wallet with the session key address and permissions.

In a React application, this can be done by using the `ConnectButton` or `ConnectEmbed` component. This will automatically configure the smart wallet with the session key address and permissions.

```typescript
<ConnectButton
  accountAbstraction={{
    chain: sepolia,
    sessionKey: {
      address: sessionKeyAccountAddress,
      permissions: {
        // "*" allows all targets, or specify specific contract addresses
        approvedTargets: "*",
      },
    },
    sponsorGas: true,
  }}
/>
```

This can also be done in pure TypeScript by using the `smartWallet` function and connecting it to a personal account.

For this guide, we'll generate a random personal account that will be used to create the smart wallet:

```typescript
// this would be the user's personal account
const personalAccount = await generateAccount({
  client: client,
});

// wrapped in a smart wallet with session key permissions
const smart = smartWallet({
  chain: sepolia,
  sessionKey: {
    address: sessionKeyAccountAddress,
    permissions: {
      // "*" allows all targets, or specify specific contract addresses
      approvedTargets: "*",
    },
  },
  sponsorGas: true, // Enable gas sponsorship
});

console.log("Personal account created:", personalAccount.address);
```

### Session Key Permissions

The `permissions` object allows you to control what the session key can do:

- `approvedTargets`: Specify which contract addresses the session key can interact with
  - Use `"*"` for all targets
  - Use an array of addresses for specific contracts: `["0x123...", "0x456..."]`

## Step 2: Connect Smart Account

Connect the smart wallet using the personal account:

```typescript
const smartAccount = await smart.connect({
  client: client,
  personalAccount: personalAccount,
});

console.log("Smart account address:", smartAccount.address);
```

Note that in a React application, this would be done automatically by the `ConnectButton` or `ConnectEmbed` component.

## Step 3 (Optional): Verify Session Key Registration

Check that the session key is properly registered as an active signer:

```typescript
const signers = await getAllActiveSigners({
  contract: getContract({
    address: smartAccount.address,
    chain: sepolia,
    client: client,
  }),
});

// Verify the session key is in the list of active signers
const isSessionKeyActive = signers
  .map((s) => s.signer)
  .includes(sessionKeyAccountAddress);

console.log("Session key is active:", isSessionKeyActive);
console.log("All active signers:", signers.map((s) => s.signer));
```

## Step 4: Create Engine Server Wallet

Set up an Engine server wallet using the session key for transaction execution:

```typescript
const serverWallet = Engine.serverWallet({
  address: sessionKeyAccountAddress,
  chain: sepolia,
  client: client,
  executionOptions: {
    entrypointVersion: "0.6", // ERC-4337 entrypoint version
    signerAddress: sessionKeyAccountAddress,
    smartAccountAddress: smartAccount.address,
    type: "ERC4337",
  },
});
```

### Execution Options

- `entrypointVersion`: The ERC-4337 entrypoint version to use
- `signerAddress`: The session key address that will sign transactions
- `smartAccountAddress`: The smart account address that will execute transactions
- `type`: The account abstraction type (ERC4337)

## Step 5: Execute Transactions

Now you can execute transactions using the session key, here we are sending 0 ETH to the target address for testing purposes:

```typescript
const tx = await sendTransaction({
  account: serverWallet,
  transaction: {
    chain: sepolia,
    client: client,
    to: targetAddress,
    value: 0n, // Amount in wei (0 for no ETH transfer)
    // data: "0x...", // Optional: contract call data
  },
});

console.log("Transaction sent:", tx.transactionHash);
```

## Complete Example

Here's a complete example putting it all together:

```typescript
import { 
  generateAccount, 
  smartWallet, 
  sendTransaction, 
  getContract,
  createThirdwebClient
} from "thirdweb";
import { sepolia } from "thirdweb/chains";
import { getAllActiveSigners } from "thirdweb/extensions/erc4337";
import { Engine } from "thirdweb/engine";

async function executeTransactionWithSessionKey() {
  // Configuration
  const client = createThirdwebClient({
    clientId: "your-client-id",
    secretKey: "your-secret-key"
  });
  
  const sessionKeyAccountAddress = "0x..."; // Your session key address (server wallet)
  const targetAddress = "0x..."; // Target address for the final transaction
  
  try {
    // Step 1: Create personal account
    const personalAccount = await generateAccount({ client });
    
    // Step 2: Configure smart wallet
    const smart = smartWallet({
      chain: sepolia,
      sessionKey: {
        address: sessionKeyAccountAddress,
        permissions: {
          approvedTargets: "*",
        },
      },
      sponsorGas: true,
    });
    
    // Step 3: Connect smart account
    const smartAccount = await smart.connect({
      client,
      personalAccount,
    });
    
    // Step 4: Verify session key
    const signers = await getAllActiveSigners({
      contract: getContract({
        address: smartAccount.address,
        chain: sepolia,
        client,
      }),
    });
    
    const isSessionKeyActive = signers
      .map((s) => s.signer)
      .includes(sessionKeyAccountAddress);
    
    if (!isSessionKeyActive) {
      throw new Error("Session key is not active");
    }
    
    // Step 5: Create server wallet
    const serverWallet = Engine.serverWallet({
      address: sessionKeyAccountAddress,
      chain: sepolia,
      client,
      executionOptions: {
        entrypointVersion: "0.6",
        signerAddress: sessionKeyAccountAddress,
        smartAccountAddress: smartAccount.address,
        type: "ERC4337",
      },
    });
    
    // Step 6: Execute transaction
    const tx = await sendTransaction({
      account: serverWallet,
      transaction: {
        chain: sepolia,
        client,
        to: targetAddress,
        value: 0n,
      },
    });
    
    console.log("Transaction successful:", tx.transactionHash);
    return tx;
    
  } catch (error) {
    console.error("Error executing transaction:", error);
    throw error;
  }
}

// Execute the function
executeTransactionWithSessionKey()
  .then((tx) => console.log("Done!", tx.transactionHash))
  .catch((error) => console.error("Failed:", error));
```

## Security Considerations

- **Session Key Storage**: Store session keys securely, preferably in a vault system
- **Permission Scope**: Limit session key permissions to only necessary targets
- **Key Rotation**: Regularly rotate session keys for enhanced security
- **Monitoring**: Monitor session key usage for suspicious activity

## Troubleshooting

### Common Issues

1. **Session key not active**: Ensure the session key is properly registered with the smart account
2. **Permission denied**: Check that the target address is included in `approvedTargets`
3. **Gas estimation failed**: Verify that gas sponsorship is properly configured


</TabsContent>

<TabsContent value="erc7702">

## Prerequisites

Before you begin, ensure you have:
- A thirdweb client configured
- An in-app wallet with ERC-7702 support
- A session key account address (can be generated or an existing wallet)

## Setup

First, let's set up the necessary imports and configuration:

```typescript
import { 
  createThirdwebClient,
  getContract,
  sendTransaction,
  prepareTransaction
} from "thirdweb";
import { sepolia } from "thirdweb/chains";
import { inAppWallet, createSessionKey } from "thirdweb/wallets/in-app";

// Configure your client
const client = createThirdwebClient({
  clientId: "your-client-id",
  secretKey: "your-secret-key" // Only use in server environments
});

// Your session key account address
const sessionKeyAccountAddress = "0x..."; // Replace with your session key address (server wallet)
```

## Step 1: Create ERC-7702 Smart EOA

Create an in-app wallet configured with ERC-7702 execution mode:

```typescript
const wallet = inAppWallet({
  executionMode: {
    mode: "EIP7702",
    sponsorGas: true, // Enable gas sponsorship
  },
});

// Connect the wallet (user authentication)
const account = await wallet.connect({
  chain: sepolia,
  client: client,
  strategy: "google", // or "email", "guest", etc.
});

console.log("Upgraded EOA address:", account.address);
```

### Execution Modes

The `executionMode` option allows you to configure the wallet behavior:

- `mode`: Set to `"EIP7702"` for EIP-7702 upgraded EOA functionality
- `sponsorGas`: Enable gas sponsorship for gasless transactions

## Step 2: Get Account Contract

Create a contract instance for the deployed smart EOA:

```typescript
const accountContract = getContract({
  address: account.address,
  chain: sepolia,
  client: client,
});
```

## Step 3: Create Session Key with Full Permissions

Add a session key with full execution permissions:

```typescript
const tx = await sendTransaction({
  account: account,
  transaction: createSessionKey({
    account: account,
    contract: accountContract,
    sessionKeyAddress: sessionKeyAccountAddress,
    durationInSeconds: 86400, // 1 day
    grantFullPermissions: true, // Allow unrestricted access
  }),
});

console.log("Session key created:", tx.transactionHash);
```

### Session Key Options

- `account`: The admin account that will create the session key
- `contract`: The smart EOA contract instance
- `sessionKeyAddress`: The address that will be granted session key permissions
- `durationInSeconds`: How long the session key should be valid (in seconds)
- `grantFullPermissions`: If `true`, grants unrestricted access. If `false`, you must specify policies.

## Step 4 (Advanced): Create Session Key with Granular Permissions

For more fine-grained control, you can specify call and transfer policies:

```typescript
import { Condition, LimitType } from "thirdweb/wallets/in-app";

const tx = await sendTransaction({
  account: account,
  transaction: createSessionKey({
    account: account,
    contract: accountContract,
    sessionKeyAddress: sessionKeyAccountAddress,
    durationInSeconds: 86400, // 1 day
    grantFullPermissions: false, // Use granular permissions
    callPolicies: [
      {
        target: "0x123...", // Target contract address
        selector: "0xa9059cbb", // Function selector (e.g., ERC20 transfer)
        maxValuePerUse: 0n, // Max ETH value per call
        valueLimit: {
          limitType: LimitType.Lifetime, // Lifetime limit
          limit: 1000000n, // Max total value in wei
          period: 0n, // Not used for lifetime limits
        },
        constraints: [
          {
            condition: Condition.Equal, // Constraint type
            index: 0n, // Parameter index
            refValue: "0x000000000000000000000000abc...", // Expected value
          },
        ],
      },
    ],
    transferPolicies: [
      {
        target: "0x456...", // Recipient address for transfers
        maxValuePerUse: 100000n, // Max wei per transfer
        valueLimit: {
          limitType: LimitType.Allowance, // Allowance-based limit
          limit: 1000000n, // Total allowance in wei
          period: 86400n, // Reset period in seconds
        },
      },
    ],
  }),
});

console.log("Session key with policies created:", tx.transactionHash);
```

### Permission Types

#### Call Policies

Control which smart contract calls the session key can make:

- `target`: The contract address the session key can call
- `selector`: The function selector (4-byte identifier) that can be called
- `maxValuePerUse`: Maximum ETH value that can be sent per transaction
- `valueLimit`: Total value limits over time
- `constraints`: Parameter-level constraints for function calls

#### Transfer Policies

Control native token transfers the session key can make:

- `target`: The recipient address for transfers
- `maxValuePerUse`: Maximum wei per individual transfer
- `valueLimit`: Total transfer limits over time

#### Limit Types

```typescript
enum LimitType {
  Unlimited = 0,  // No limit
  Lifetime = 1,   // One-time total limit
  Allowance = 2,  // Renewable allowance based on period
}
```

#### Constraint Conditions

```typescript
enum Condition {
  Unconstrained = 0,    // No constraint
  Equal = 1,            // Must equal reference value
  Greater = 2,          // Must be greater than reference value
  Less = 3,             // Must be less than reference value
  GreaterOrEqual = 4,   // Must be >= reference value
  LessOrEqual = 5,      // Must be <= reference value
  NotEqual = 6,         // Must not equal reference value
}
```

## Step 5: Use the Session Key

Once created, the session key can be used with Engine or other server-side execution:

```typescript
import { Engine } from "thirdweb/engine";

const serverWallet = Engine.serverWallet({
  address: sessionKeyAccountAddress,
  chain: sepolia,
  client: client,
});

// Execute transactions with the session key
const tx = await sendTransaction({
  account: serverWallet,
  transaction: prepareTransaction({
    chain: sepolia,
    client: client,
    to: "0x...", // Target address
    value: 0n,
  }),
});

console.log("Transaction executed:", tx.transactionHash);
```

## Complete Example

Here's a complete example for setting up and using a session key with ERC-7702:

```typescript
import { 
  createThirdwebClient,
  getContract,
  sendTransaction,
  prepareTransaction
} from "thirdweb";
import { sepolia } from "thirdweb/chains";
import { inAppWallet, createSessionKey } from "thirdweb/wallets/in-app";
import { Engine } from "thirdweb/engine";

async function setupSessionKeyWith7702() {
  // Configuration
  const client = createThirdwebClient({
    clientId: "your-client-id",
    secretKey: "your-secret-key"
  });
  
  const sessionKeyAccountAddress = "0x..."; // Your session key address (server wallet)
  
  try {
    // Step 1: Create 7702 Smart EOA
    const wallet = inAppWallet({
      executionMode: {
        mode: "EIP7702",
        sponsorGas: true,
      },
    });
    
    const account = await wallet.connect({
      chain: sepolia,
      client: client,
      strategy: "google",
    });
    
    console.log("Upgraded EOA created:", account.address);
    
    // Step 2: Get account contract
    const accountContract = getContract({
      address: account.address,
      chain: sepolia,
      client: client,
    });
    
    // Step 3: Create session key
    const sessionTx = await sendTransaction({
      account: account,
      transaction: createSessionKey({
        account: account,
        contract: accountContract,
        sessionKeyAddress: sessionKeyAccountAddress,
        durationInSeconds: 86400, // 1 day
        grantFullPermissions: true,
      }),
    });
    
    console.log("Session key created:", sessionTx.transactionHash);
    
    // Step 4: Use the session key with Engine
    const serverWallet = Engine.serverWallet({
      address: sessionKeyAccountAddress,
      chain: sepolia,
      client: client,
    });
    
    // Execute a transaction with the session key
    const tx = await sendTransaction({
      account: serverWallet,
      transaction: prepareTransaction({
        chain: sepolia,
        client: client,
        to: "0x...", // Target address
        value: 0n,
      }),
    });
    
    console.log("Transaction successful:", tx.transactionHash);
    return tx;
    
  } catch (error) {
    console.error("Error:", error);
    throw error;
  }
}

// Execute the function
setupSessionKeyWith7702()
  .then((tx) => console.log("Done!", tx.transactionHash))
  .catch((error) => console.error("Failed:", error));
```

## Security Considerations

- **Session Key Storage**: Store session keys securely, preferably in a vault system
- **Permission Scope**: Use granular permissions (`grantFullPermissions: false`) for production use cases
- **Time Limits**: Set appropriate `durationInSeconds` values based on your use case
- **Policy Design**: Carefully design call and transfer policies to minimize risk
- **Key Rotation**: Regularly rotate session keys and revoke unused ones
- **Monitoring**: Monitor session key usage for suspicious activity

## Troubleshooting

### Common Issues

1. **Account not deployed**: Ensure you've sent a transaction to trigger the account deployment/upgrade
2. **Invalid signature**: Make sure the admin account is properly authenticated and can sign typed data
3. **Permission denied**: Verify the session key has the necessary policies for the operation
4. **Expired session key**: Check that the current time is within the session key's validity period


</TabsContent>
</Tabs>

## Next Steps

- Learn more about [In-App Wallets](/wallets/users)
- Explore the [API Reference](/reference)
- Check out the [TypeScript SDK](/references/typescript/v5) documentation
