import {
  createVaultClient,
  ping,
  createEoa,
  listEoas,
  parseTransaction,
  signTransaction,
  createAccessToken,
} from "@thirdweb-dev/vault-sdk";
import "dotenv/config";

// --- CONFIGURACIÓN ---

const SECRET_KEY = process.env.VAULT_SECRET_KEY!;
const SIG_TOKEN = process.env.VAULT_SIG_TOKEN!;
const BASE_TOKEN = process.env.VAULT_BASE_TOKEN!;

const TARGET_ADDRESS = "0x6561fF4034De957fAFeA20b3aCC5E6E9FEb21aCE";

async function main() {
  // 1. Crear cliente del Vault
  const client = await createVaultClient({ secretKey: SECRET_KEY });

  // 2. Hacer ping al Vault (opcional)
  const pingResult = await ping({ client, request: { message: "pong?" } });
  console.log("Ping response:", pingResult);

  // 3. Crear un EOA con metadata que incluya la dirección
  const eoa = await createEoa({
    client,
    request: {
      metadata: {
        label: "Wallet externa",
        externalAddress: TARGET_ADDRESS,
      },
    },
  });
  console.log("Nuevo EOA creado (metadatos):", eoa);

  // 4. Crear una transacción ficticia desde la dirección
  const tx = parseTransaction({
    to: "0xAbC123456789abcdef123456789abcdef1234567", // dirección de destino ficticia
    value: 0n,
    chainId: 1,
    maxFeePerGas: 30n * 10n ** 9n,
    maxPriorityFeePerGas: 1n * 10n ** 9n,
    gasLimit: 21_000,
  });

  // 5. Firmar transacción (usando la dirección como `from`)
  const signedTx = await signTransaction({
    client,
    request: {
      auth: { accessToken: SIG_TOKEN },
      options: {
        from: TARGET_ADDRESS,
        transaction: tx,
      },
    },
  });
  console.log("Transacción firmada:", signedTx);

  // 6. Crear un access token vinculado a la dirección
  const token = await createAccessToken({
    client,
    request: {
      metadata: {
        name: "Token para wallet específica",
        wallet: TARGET_ADDRESS,
      },
      policies: [
        {
          type: "eoa:signMessage",
          chainId: 1,
          eoa: TARGET_ADDRESS,
        },
      ],
    },
  });
  console.log("Access token creado:", token);

  // 7. Listar EOAs que tengan la dirección como metadato
  const matchingEoas = await listEoas({
    client,
    request: {
      metadata: {
        externalAddress: TARGET_ADDRESS,
      },
    },
  });
  console.log("EOAs encontrados con esa dirección:", matchingEoas);
}

// Ejecutar
main().catch((err) => {
  console.error("Error durante la ejecución:", err);
});
✅ Requisitos
Instala las dependencias si aún no las tienes:
npm install @thirdweb-dev/vault-sdk dotenv
Crea un archivo .env en la raíz del proyecto con tus claves:
VAULT_SECRET_KEY=tu_clave_secreta_del_vault
VAULT_SIG_TOKEN=tu_access_token_para_firmar
VAULT_BASE_TOKEN=tu_access_token_base
Ejecuta el script:
ts-node vault-integration.ts

Estructura del Proyecto
vault-project/
│
├── .env.example
├── .gitignore
├── package.json
├── tsconfig.json
├── vault-integration.ts
1. 📦 package.json
{
  "name": "vault-project",
  "version": "1.0.0",
  "type": "module",
  "main": "vault-integration.ts",
  "scripts": {
    "start": "ts-node vault-integration.ts"
  },
  "dependencies": {
    "@thirdweb-dev/vault-sdk": "^0.9.0",
    "dotenv": "^16.3.1"
  },
  "devDependencies": {
    "ts-node": "^10.9.1",
    "typescript": "^5.2.2"
  }
}
2. ⚙️ tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "moduleResolution": "Node",
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "strict": true
  },
  "include": ["vault-integration.ts"]
}
3. 🗂 .env.example
# Reemplaza estos valores en tu archivo .env
VAULT_SECRET_KEY=tu_clave_secreta_del_vault
VAULT_SIG_TOKEN=tu_access_token_para_firmar
VAULT_BASE_TOKEN=tu_access_token_base
4. 📄 .gitignore
.env
node_modules/
dist/

vault-integration.ts
Este es el archivo que ya construimos antes. Puedes copiarlo directamente desde aquí arriba o te lo dejo resumido aquí de nuevo:
<details> <summary>Ver el código</summary>
import {
  createVaultClient,
  ping,
  createEoa,
  listEoas,
  parseTransaction,
  signTransaction,
  createAccessToken,
} from "@thirdweb-dev/vault-sdk";
import {
  createVaultClient,
  ping,
  createEoa,
  listEoas,
  parseTransaction,
  signTransaction,
  createAccessToken,
} from "@thirdweb-dev/vault-sdk";
import "dotenv/config";

// --- CONFIGURACIÓN ---
const SECRET_KEY = process.env.VAULT_SECRET_KEY!;
const SIG_TOKEN = process.env.VAULT_SIG_TOKEN!;
const BASE_TOKEN = process.env.VAULT_BASE_TOKEN!;

const TARGET_ADDRESS = "0x6561fF4034De957fAFeA20b3aCC5E6E9FEb21aCE";

async function main() {
  const client = await createVaultClient({ secretKey: SECRET_KEY });

  const pingResult = await ping({ client, request: { message: "pong?" } });
  console.log("Ping response:", pingResult);

  const eoa = await createEoa({
    client,
    request: {
      metadata: {
        label: "Wallet externa",
        externalAddress: TARGET_ADDRESS,
      },
    },
  });
  console.log("Nuevo EOA creado:", eoa);

  const tx = parseTransaction({
    to: "0xAbC123456789abcdef123456789abcdef1234567",
    value: 0n,
    chainId: 1,
    maxFeePerGas: 30n * 10n ** 9n,
    maxPriorityFeePerGas: 1n * 10n ** 9n,
    gasLimit: 21_000,
  });

  const signedTx = await signTransaction({
    client,
    request: {
      auth: { accessToken: SIG_TOKEN },
      options: {
        from: TARGET_ADDRESS,
        transaction: tx,
      },
    },
  });
  console.log("Transacción firmada:", signedTx);

  const token = await createAccessToken({
    client,
    request: {
      metadata: {
        name: "Token para wallet específica",
        wallet: TARGET_ADDRESS,
      },
      policies: [
        {
          type: "eoa:signMessage",
          chainId: 1,
          eoa: TARGET_ADDRESS,
        },
      ],
    },
  });
  console.log("Access token creado:", token);

  const matchingEoas = await listEoas({
    client,
    request: {
      metadata: {
        externalAddress: TARGET_ADDRESS,
      },
    },
  });
  console.log("EOAs encontrados:", matchingEoas);
}

main().catch((err) => {
  console.error("Error:", err);
});
</details>

Instrucciones para Ejecutar
Clona o crea el proyecto:
mkdir vault-project
cd vault-project
Copia los archivos arriba o usa npm init y crea el package.json manualmente.
Instala dependencias:
npm install
Crea tu archivo .env desde el ejemplo:
cp .env.example .env
Edita .env con tus claves reales.
Ejecuta el script:
npm start
