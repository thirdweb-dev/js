import { Details, Callout, createMetadata } from "@doc";

export const metadata = createMetadata({
	title: "EcosystemWallet.Create | Thirdweb .NET SDK",
	description:
		"Instantiate an EcosystemWallet for secure user authentication and interaction.",
});

# EcosystemWallet.Create

Create an instance of `EcosystemWallet` using a user's email, phone number or OAuth. This wallet type facilitates secure user authentication through OTP verification, making it suitable for client-facing applications where handling private keys directly is not ideal.

## Usage

```csharp
// NOTE: All creation examples below may take in an `ecosystemPartnerId` if you are the ecosystem partner integrating with a third-party ecosystem

// Email
var wallet = await EcosystemWallet.Create(client: client, ecosystemId: "ecosystem.my-ecosystem", email: "userEmail");
// Phone
var wallet = await EcosystemWallet.Create(client: client, ecosystemId: "ecosystem.my-ecosystem", phoneNumber: "+1234567890");
// Google, Apple, Facebook, etc.
var wallet = await EcosystemWallet.Create(client: client, ecosystemId: "ecosystem.my-ecosystem", authProvider: AuthProvider.Google);
// SIWE
var wallet = await EcosystemWallet.Create(client: client, ecosystemId: "ecosystem.my-ecosystem", authProvider: AuthProvider.Siwe, siweSigner: anyExternalWallet);
// Custom Auth - JWT
var wallet = await EcosystemWallet.Create(client: client, ecosystemId: "ecosystem.my-ecosystem", authProvider: AuthProvider.JWT);
// Custom Auth - AuthEndpoint
var wallet = await EcosystemWallet.Create(client: client, ecosystemId: "ecosystem.my-ecosystem", authProvider: AuthProvider.AuthEndpoint);

// Session resuming supported for all methods
var isConnected = await wallet.IsConnected();

// If not connected, initiate login flow based on the auth provider you are using

// Email & Phone (OTP)
await wallet.SendOTP(); // and fetch the otp
var (address, canRetry) = await wallet.LoginWithOtp("userEnteredOTP");

// Socials (OAuth)
var address = await wallet.LoginWithOauth(
    // Windows console app example, adaptable to any runtime
    isMobile: false,
    browserOpenAction: (url) =>
    {
        var psi = new ProcessStartInfo { FileName = url, UseShellExecute = true };
        _ = Process.Start(psi);
    },
    mobileRedirectScheme: "myBundleId://"
);

// SIWE (Wallet)
var address = await siweWallet.LoginWithSiwe(chainId: 1);

// Custom Auth (JWT)
var address = await wallet.LoginWithCustomAuth(jwt: "myjwt", encryptionkey: "myencryptionkey");

// Custom Auth (AuthEndpoint)
var address = await wallet.LoginWithAuthEndpoint(payload: "mypayload", encryptionkey: "myencryptionkey");
```

<Callout variant="info" title="Client-Side Use">
	This wallet is designed for client-side use in applications where direct access to the user's private keys is not safe or necessary. It leverages OTP for secure authentication, allowing users to interact with blockchain applications seamlessly.
</Callout>
<Details summary="Parameters">

### client (required)

An instance of `ThirdwebClient`.

### ecosystemId (required)

The ID of the ecosyste wallet you created on the dashboard.

### ecosystemPartnerId (optional)

The partner ID you were provided by the Ecosystem owner.

### email (optional)

The user's email address. Required if `phoneNumber` is not provided.

### phoneNumber (optional)

The user's phone number. Required if `email` is not provided.

### authProvider (optional)

The OAuth provider to use for authentication. Supported values are `AuthProvider.Google`, `AuthProvider.Apple`, `AuthProvider.Facebook`.

### storageDirectoryPath (optional)

The path to the directory where the wallet data is stored. Defaults to the application's data directory.

</Details>

<Details summary="Return Value">

### EcosystemWallet

Returns an instance of EcosystemWallet, initialized for the user based on the provided email or phone number. This wallet is ready for OTP authentication and further blockchain interactions.

</Details>

## OTP Authentication Flow

The OTP authentication flow involves sending an OTP to the user's email or phone and then verifying the OTP to complete authentication:

**Send OTP:** Initiate the login process by calling SendOTP on the EcosystemWallet instance. This sends an OTP to the user's email or phone number.

```csharp
await wallet.SendOTP();
```

**Submit OTP:** Once the user receives the OTP, they submit it back to the application, which then calls LoginWithOtp on the EcosystemWallet instance to verify the OTP and complete the login process.

```csharp
var (address, canRetry) = await wallet.LoginWithOtp("userEnteredOTP");
if (address != null) {
    // Login successful
} else if (canRetry) {
    // Ask user to retry entering OTP
}
```

## Example

Here's an example of creating an `EcosystemWallet` with a user's email and completing the OTP authentication flow:

```csharp
// Create EcosystemWallet wallet as signer to unlock web2 auth
var ecosystemWallet = await EcosystemWallet.Create(client: client, ecosystemId: "ecosystem.my-ecosystem", email: "email@email.com"); // or email: null, phoneNumber: "+1234567890"

// Resume session (if `EcosystemWallet` wallet was not logged in)
if (!await ecosystemWallet.IsConnected())
{
    await ecosystemWallet.SendOTP();
    Console.WriteLine("Please submit the OTP.");
    var otp = Console.ReadLine();
    (var ecosystemWalletAddress, var canRetry) = await ecosystemWallet.LoginWithOtp(otp);
    if (ecosystemWalletAddress == null && canRetry)
    {
        Console.WriteLine("Please submit the OTP again.");
        otp = Console.ReadLine();
        (ecosystemWalletAddress, _) = await ecosystemWallet.LoginWithOtp(otp);
    }
    if (ecosystemWalletAddress == null)
    {
        Console.WriteLine("OTP login failed. Please try again.");
        return;
    }
}

Console.WriteLine($"EcosystemWallet address: {await ecosystemWallet.GetAddress()}");

// Sign a message
var message = "Hello, Thirdweb!";
var signature = await wallet.PersonalSign(message);
Console.WriteLine($"Signature: {signature}");
```

**Note:** EcosystemWallet leverages the security of OTP-based authentication to ensure a secure and user-friendly experience in blockchain applications.

## OAuth Authentication Flow

**LoginWithOauth:** Initiate the login process by calling LoginWithOauth on the EcosystemWallet instance. This redirects the user to the OAuth provider's login page.

```csharp
// Windows console app example
var address = await ecosystemWallet.LoginWithOauth(
    isMobile: false,
    browserOpenAction: (url) =>
    {
        var psi = new ProcessStartInfo { FileName = url, UseShellExecute = true };
        _ = Process.Start(psi);
    },
);
// Godot standalone example
var address = await ThirdwebManager.Instance.EcosystemWallet.LoginWithOauth(
        isMobile: OS.GetName() == "Android" || OS.GetName() == "iOS",
        browserOpenAction: (url) => OS.ShellOpen(url),
        mobileRedirectScheme: "thirdweb://"
);
```

<Details summary="Parameters">

### isMobile

A `bool` indicating whether the application is running on a mobile platform.

### browserOpenAction

An `Action<string>` that opens the OAuth provider's login page in a browser.

### mobileRedirectScheme

The redirect scheme to use for mobile platforms. Defaults to `"thirdweb://"`.

### browser

An instance of `IThirdwebBrowser` to use for the OAuth login process. Defaults to `null`.

### cancellationToken

A `CancellationToken` to cancel the operation. Defaults to `default`.

</Details>

<Details summary="Return Value">

### string

The EcosystemWallet address as a hexadecimal `string`.

</Details>

## Example

Here's an example of creating an `EcosystemWallet` using OAuth.

```csharp
// Create EcosystemWallet wallet as signer to unlock web2 auth
var ecosystemWallet = await EcosystemWallet.Create(client: client, ecosystemId: "ecosystem.my-ecosystem", authProvider: AuthProvider.Google);

// Resume session (if `EcosystemWallet` wallet was not logged in)
if (!await ecosystemWallet.IsConnected())
{
    try {
        var address = await ecosystemWallet.LoginWithOauth(
            isMobile: false,
            browserOpenAction: (url) =>
            {
                var psi = new ProcessStartInfo { FileName = url, UseShellExecute = true };
                _ = Process.Start(psi);
            },
        );
        Console.WriteLine($"OAuth login successful. EcosystemWallet address: {address}");
    } catch (Exception ex) {
        Console.WriteLine($"OAuth login failed: {ex.Message}");
        return;
    }
}
```

**Note:** The `LoginWithOauth` API allows for custom browser handling, making it suitable for various application types and platforms.

## Unified Identity - Account Linking

EcosystemWallet supports linking multiple authentication methods to a single user account. This feature enables users to access their account using different authentication methods, such as email, phone, or OAuth, without creating separate accounts for each method.

### Linking Accounts

```csharp
var ecosystemWalletMain = await EcosystemWallet.Create(client: client, ecosystemId: "ecosystem.my-ecosystem", authProvider: AuthProvider.Google);
if (!await ecosystemWalletMain.IsConnected())
{
    _ = await ecosystemWalletMain.LoginWithOauth(
        isMobile: false,
        (url) =>
        {
            var psi = new ProcessStartInfo { FileName = url, UseShellExecute = true };
            _ = Process.Start(psi);
        },
        "thirdweb://",
        new EcosystemWalletBrowser()
    );
}
Console.WriteLine($"Main EcosystemWallet address: {await ecosystemWalletMain.GetAddress()}");

// Prepare Telegram
var socialWallet = await EcosystemWallet.Create(client: client, ecosystemId: "ecosystem.my-ecosystem", authProvider: AuthProvider.Telegram);
// Link Telegram
_ = await ecosystemWalletMain.LinkAccount(walletToLink: socialWallet,);

// Prepare Phone
var phoneWallet = await EcosystemWallet.Create(client: client, ecosystemId: "ecosystem.my-ecosystem", phoneNumber: "+1234567890");
_ = await phoneWallet.SendOTP();
var otp = Console.ReadLine();
// Link Phone
_ = await ecosystemWalletMain.LinkAccount(walletToLink: phoneWallet, otp: otp);
```

### Getting Linked Accounts

```csharp
List<LinkedAccount> linkedAccounts = await ecosystemWalletMain.GetLinkedAccounts();
```
